---
title: å¹‚ç­‰æ€§ä¸é‡è¯•æœ€ä½³å®è·µæŒ‡å—
tags: [ æ¶æ„å¸ˆ, best practice]
categories: [ ç¼–ç¨‹äººç”Ÿ ]
date: 2025-09-17 02:05:05
---

é€šè¿‡å¹‚ç­‰æ€§è®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥æ—¢ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œåˆé¿å…é‡å¤æ“ä½œçš„é£é™©ï¼Œè¿™æ˜¯å¤„ç†æ”¯ä»˜ç­‰å…³é”®ä¸šåŠ¡çš„æ ‡å‡†åšæ³•ã€‚
<!-- more -->

## ğŸš« ä¸ºä»€ä¹ˆä¸å»ºè®®å¯¹æ”¯ä»˜æ“ä½œä½¿ç”¨é‡è¯•

### 1. æ ¸å¿ƒé—®é¢˜ï¼šéå¹‚ç­‰æ€§

**å¹‚ç­‰æ€§å®šä¹‰**ï¼šåŒä¸€ä¸ªæ“ä½œé‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œç»“æœåº”è¯¥ä¸æ‰§è¡Œä¸€æ¬¡ç›¸åŒã€‚

```java
// å¹‚ç­‰æ“ä½œç¤ºä¾‹
GET /api/user/123        // å¤šæ¬¡æŸ¥è¯¢åŒä¸€ç”¨æˆ·ï¼Œç»“æœç›¸åŒ
PUT /api/user/123        // å¤šæ¬¡æ›´æ–°åŒä¸€ç”¨æˆ·ä¸ºç›¸åŒæ•°æ®ï¼Œç»“æœç›¸åŒ

// éå¹‚ç­‰æ“ä½œç¤ºä¾‹  
POST /api/payment        // æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°çš„æ”¯ä»˜ï¼
POST /api/order          // æ¯æ¬¡éƒ½ä¼šåˆ›å»ºæ–°çš„è®¢å•ï¼
```

### 2. æ”¯ä»˜é‡è¯•çš„ä¸¥é‡é£é™©

#### æ—¶é—´çº¿åˆ†æ
```
T1: å®¢æˆ·ç«¯å‘èµ·æ”¯ä»˜è¯·æ±‚ 100å…ƒ
T2: æœåŠ¡å™¨æ¥æ”¶è¯·æ±‚ï¼Œè°ƒç”¨æ”¯ä»˜ç½‘å…³
T3: æ”¯ä»˜ç½‘å…³æ‰£æ¬¾æˆåŠŸ âœ“
T4: ç½‘ç»œæ•…éšœï¼Œå“åº”ä¸¢å¤± âŒ  
T5: å®¢æˆ·ç«¯è¶…æ—¶ï¼Œé‡è¯•æœºåˆ¶è§¦å‘
T6: æœåŠ¡å™¨å†æ¬¡è°ƒç”¨æ”¯ä»˜ç½‘å…³
T7: å†æ¬¡æ‰£æ¬¾ 100å…ƒ âŒ
ç»“æœï¼šç”¨æˆ·æŸå¤± 200å…ƒï¼
```

#### å®é™…æ¡ˆä¾‹é£é™©
- **é‡å¤æ‰£æ¬¾**ï¼šç”¨æˆ·è¢«å¤šæ¬¡æ‰£é™¤è´¹ç”¨
- **è´¦åŠ¡ä¸ä¸€è‡´**ï¼šè®¢å•çŠ¶æ€ä¸å®é™…æ”¯ä»˜çŠ¶æ€ä¸ç¬¦
- **ç”¨æˆ·ä½“éªŒæå·®**ï¼šç”¨æˆ·æŠ•è¯‰ã€é€€æ¬¾çº çº·
- **æ³•å¾‹é£é™©**ï¼šå¯èƒ½æ¶‰åŠèµ„é‡‘å®‰å…¨è´£ä»»

## âœ… æ¨èçš„è§£å†³æ–¹æ¡ˆ

### 1. å¹‚ç­‰æ€§ä»¤ç‰Œæœºåˆ¶

#### å®ç°åŸç†
```java
public class IdempotentPaymentService {
    // ä½¿ç”¨å¹‚ç­‰æ€§ä»¤ç‰Œç¡®ä¿åŒä¸€è¯·æ±‚åªå¤„ç†ä¸€æ¬¡
    public PaymentResult processPayment(String idempotencyKey, PaymentRequest request) {
        // 1. æ£€æŸ¥ç¼“å­˜
        if (cache.contains(idempotencyKey)) {
            return cache.get(idempotencyKey); // è¿”å›åŸç»“æœ
        }
        
        // 2. æ‰§è¡Œæ”¯ä»˜ï¼ˆä¸ä½¿ç”¨é‡è¯•ï¼‰
        PaymentResult result = paymentGateway.process(request);
        
        // 3. ç¼“å­˜ç»“æœ
        cache.put(idempotencyKey, result);
        return result;
    }
}
```

#### å¹‚ç­‰æ€§ä»¤ç‰Œç”Ÿæˆç­–ç•¥
```java
// æ–¹æ¡ˆ1ï¼šå®¢æˆ·ç«¯ç”Ÿæˆ
String idempotencyKey = UUID.randomUUID().toString();

// æ–¹æ¡ˆ2ï¼šåŸºäºä¸šåŠ¡æ•°æ®ç”Ÿæˆ
String idempotencyKey = orderId + "_" + userId + "_" + timestamp;

// æ–¹æ¡ˆ3ï¼šå“ˆå¸Œç®—æ³•ç”Ÿæˆ
String idempotencyKey = MD5(orderId + userId + amount + nonce);
```

### 2. è¶…æ—¶å¤„ç†ç­–ç•¥

#### å®¢æˆ·ç«¯å¤„ç†
```java
public PaymentResult handlePaymentWithTimeout(PaymentRequest request) {
    String idempotencyKey = generateKey(request);
    
    try {
        // è®¾ç½®åˆç†è¶…æ—¶æ—¶é—´ï¼ˆå¦‚30ç§’ï¼‰
        return paymentService.processPayment(idempotencyKey, request)
                .timeout(30, TimeUnit.SECONDS);
                
    } catch (TimeoutException e) {
        // è¶…æ—¶åä¸è¦ç«‹å³é‡è¯•æ”¯ä»˜ï¼
        // åº”è¯¥æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€æˆ–æç¤ºç”¨æˆ·
        return handleTimeout(idempotencyKey, request);
    }
}

private PaymentResult handleTimeout(String idempotencyKey, PaymentRequest request) {
    // æ–¹æ¡ˆ1ï¼šæŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
    PaymentStatus status = queryPaymentStatus(idempotencyKey);
    if (status != null) {
        return convertToPaymentResult(status);
    }
    
    // æ–¹æ¡ˆ2ï¼šä½¿ç”¨ç›¸åŒä»¤ç‰Œé‡æ–°å‘èµ·ï¼ˆå®‰å…¨ï¼‰
    return paymentService.processPayment(idempotencyKey, request);
    
    // æ–¹æ¡ˆ3ï¼šæç¤ºç”¨æˆ·æ‰‹åŠ¨ç¡®è®¤
    // return promptUserForConfirmation(request);
}
```

### 3. çŠ¶æ€æŸ¥è¯¢é‡è¯•

æŸ¥è¯¢æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œå¯ä»¥å®‰å…¨é‡è¯•ï¼š

```java
public PaymentStatus queryPaymentStatus(String transactionId) throws Exception {
    return RetryTemplate.create()
            .maxAttempts(5)
            .baseDelay(1000)
            .strategy(RetryStrategy.EXPONENTIAL_BACKOFF)
            .retryOn(NetworkException.class, TimeoutException.class)
            .execute(() -> {
                return paymentGateway.queryStatus(transactionId);
            });
}
```

### 4. æ•°æ®åº“äº‹åŠ¡ä¿æŠ¤

```java
@Transactional
public PaymentResult processPaymentSafely(String idempotencyKey, PaymentRequest request) {
    // 1. æ£€æŸ¥å¹‚ç­‰æ€§è®°å½•
    PaymentRecord existing = paymentRepository.findByIdempotencyKey(idempotencyKey);
    if (existing != null) {
        return existing.toPaymentResult();
    }
    
    // 2. åˆ›å»ºå¹‚ç­‰æ€§è®°å½•ï¼ˆé˜²æ­¢å¹¶å‘ï¼‰
    PaymentRecord record = new PaymentRecord(idempotencyKey, "PROCESSING");
    paymentRepository.save(record);
    
    try {
        // 3. æ‰§è¡Œæ”¯ä»˜
        PaymentResult result = paymentGateway.process(request);
        
        // 4. æ›´æ–°è®°å½•çŠ¶æ€
        record.setStatus("SUCCESS");
        record.setTransactionId(result.getTransactionId());
        paymentRepository.save(record);
        
        return result;
        
    } catch (Exception e) {
        // 5. è®°å½•å¤±è´¥çŠ¶æ€
        record.setStatus("FAILED");
        record.setErrorMessage(e.getMessage());
        paymentRepository.save(record);
        throw e;
    }
}
```

## ğŸ“‹ æ“ä½œåˆ†ç±»æŒ‡å—

### âœ… å¯ä»¥å®‰å…¨é‡è¯•çš„æ“ä½œï¼ˆå¹‚ç­‰ï¼‰

| æ“ä½œç±»å‹ | ç¤ºä¾‹ | è¯´æ˜ |
|----------|------|------|
| **æŸ¥è¯¢æ“ä½œ** | GET /api/user/123 | ä¸æ”¹å˜ç³»ç»ŸçŠ¶æ€ |
| **çŠ¶æ€æŸ¥è¯¢** | æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ã€è®¢å•çŠ¶æ€ | åªè¯»æ“ä½œ |
| **å¹‚ç­‰æ›´æ–°** | PUT /api/user/123 | å¤šæ¬¡æ‰§è¡Œç»“æœç›¸åŒ |
| **åˆ é™¤æ“ä½œ** | DELETE /api/user/123 | åˆ é™¤ä¸å­˜åœ¨çš„èµ„æºä¹Ÿæ˜¯æˆåŠŸ |

### âŒ ä¸åº”è¯¥é‡è¯•çš„æ“ä½œï¼ˆéå¹‚ç­‰ï¼‰

| æ“ä½œç±»å‹ | ç¤ºä¾‹ | é£é™© |
|----------|------|------|
| **æ”¯ä»˜æ“ä½œ** | POST /api/payment | é‡å¤æ‰£æ¬¾ |
| **è®¢å•åˆ›å»º** | POST /api/order | é‡å¤ä¸‹å• |
| **èµ„é‡‘è½¬è´¦** | POST /api/transfer | é‡å¤è½¬è´¦ |
| **æ¶ˆæ¯å‘é€** | POST /api/sms | é‡å¤å‘é€ |
| **åº“å­˜æ‰£å‡** | POST /api/inventory/reduce | è¿‡åº¦æ‰£å‡ |

### âš ï¸ éœ€è¦ç‰¹æ®Šå¤„ç†çš„æ“ä½œ

| æ“ä½œç±»å‹ | æ¨èæ–¹æ¡ˆ |
|----------|----------|
| **æ–‡ä»¶ä¸Šä¼ ** | ä½¿ç”¨æ–‡ä»¶å“ˆå¸Œä½œä¸ºå¹‚ç­‰æ€§æ ‡è¯† |
| **æ‰¹é‡æ“ä½œ** | æ‹†åˆ†ä¸ºå¤šä¸ªå¹‚ç­‰çš„å•é¡¹æ“ä½œ |
| **å®šæ—¶ä»»åŠ¡** | ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢é‡å¤æ‰§è¡Œ |

## ğŸ› ï¸ å®ç°æœ€ä½³å®è·µ

### 1. ç¼“å­˜ç­–ç•¥

```java
// ä½¿ç”¨Rediså®ç°åˆ†å¸ƒå¼å¹‚ç­‰æ€§ç¼“å­˜
@Service
public class IdempotencyCache {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    private static final int CACHE_EXPIRE_HOURS = 24;
    
    public PaymentResult getFromCache(String key) {
        return (PaymentResult) redisTemplate.opsForValue().get(key);
    }
    
    public void putToCache(String key, PaymentResult result) {
        redisTemplate.opsForValue().set(key, result, 
            CACHE_EXPIRE_HOURS, TimeUnit.HOURS);
    }
}
```

### 2. å¹¶å‘æ§åˆ¶

```java
// ä½¿ç”¨åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜
public PaymentResult processWithLock(String idempotencyKey, PaymentRequest request) {
    String lockKey = "payment_lock:" + idempotencyKey;
    
    try (DistributedLock lock = lockService.acquire(lockKey, 30, TimeUnit.SECONDS)) {
        
        // åŒé‡æ£€æŸ¥æ¨¡å¼
        PaymentResult cached = cache.get(idempotencyKey);
        if (cached != null) {
            return cached;
        }
        
        // æ‰§è¡Œæ”¯ä»˜é€»è¾‘
        return doProcessPayment(idempotencyKey, request);
        
    } catch (LockAcquisitionException e) {
        throw new PaymentException("ç³»ç»Ÿç¹å¿™ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 3. ç›‘æ§å’Œå‘Šè­¦

```java
// æ·»åŠ ç›‘æ§æŒ‡æ ‡
@Component
public class PaymentMetrics {
    
    private final Counter duplicateRequestCounter = Counter.build()
        .name("payment_duplicate_requests_total")
        .help("é‡å¤æ”¯ä»˜è¯·æ±‚è®¡æ•°")
        .register();
    
    private final Histogram paymentDuration = Histogram.build()
        .name("payment_processing_duration_seconds")
        .help("æ”¯ä»˜å¤„ç†è€—æ—¶")
        .register();
    
    public void recordDuplicateRequest() {
        duplicateRequestCounter.inc();
    }
    
    public Timer.Sample startPaymentTimer() {
        return Timer.start(paymentDuration);
    }
}
```

## ğŸ¯ å…³é”®è¦ç‚¹æ€»ç»“

1. **æ°¸è¿œä¸è¦å¯¹éå¹‚ç­‰æ“ä½œä½¿ç”¨è‡ªåŠ¨é‡è¯•**
2. **ä½¿ç”¨å¹‚ç­‰æ€§ä»¤ç‰Œç¡®ä¿è¯·æ±‚çš„å”¯ä¸€æ€§**
3. **å°†æ”¯ä»˜æ“ä½œä¸æŸ¥è¯¢æ“ä½œåˆ†ç¦»**
4. **å»ºç«‹å®Œå–„çš„è¶…æ—¶å¤„ç†æœºåˆ¶**
5. **å®æ–½é€‚å½“çš„ç›‘æ§å’Œå‘Šè­¦**
6. **æä¾›æ¸…æ™°çš„ç”¨æˆ·åé¦ˆ**

## ğŸ’¡ å¸¸è§é—®é¢˜è§£ç­”

**Q: å¦‚æœç½‘ç»œè¶…æ—¶äº†ï¼Œç”¨æˆ·åº”è¯¥æ€ä¹ˆåŠï¼Ÿ**
A: ä¸è¦è®©ç”¨æˆ·é‡æ–°æ”¯ä»˜ï¼åº”è¯¥ï¼š
- æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€
- ä½¿ç”¨ç›¸åŒå¹‚ç­‰æ€§ä»¤ç‰Œé‡è¯•
- æˆ–å¼•å¯¼ç”¨æˆ·åˆ°è®¢å•çŠ¶æ€é¡µé¢ç¡®è®¤

**Q: å¹‚ç­‰æ€§ä»¤ç‰Œåº”è¯¥ç”±è°ç”Ÿæˆï¼Ÿ**
A: æ¨èç”±å®¢æˆ·ç«¯ç”Ÿæˆï¼Œè¿™æ ·å¯ä»¥ç¡®ä¿åœ¨å®¢æˆ·ç«¯é‡è¯•æ—¶ä½¿ç”¨ç›¸åŒçš„ä»¤ç‰Œã€‚

**Q: ç¼“å­˜åº”è¯¥ä¿å­˜å¤šé•¿æ—¶é—´ï¼Ÿ**
A: å»ºè®®è‡³å°‘24å°æ—¶ï¼Œå¯¹äºé‡è¦ä¸šåŠ¡å¯ä»¥è€ƒè™‘7å¤©ã€‚è¦å¹³è¡¡å­˜å‚¨æˆæœ¬å’Œç”¨æˆ·ä½“éªŒã€‚

**Q: å¦‚ä½•å¤„ç†æ”¯ä»˜ç½‘å…³çš„é‡å¤å›è°ƒï¼Ÿ**
A: åŒæ ·ä½¿ç”¨å¹‚ç­‰æ€§æœºåˆ¶ï¼Œä»¥å›è°ƒä¸­çš„äº¤æ˜“IDä½œä¸ºå¹‚ç­‰æ€§æ ‡è¯†ã€‚

é€šè¿‡éµå¾ªè¿™äº›åŸåˆ™å’Œå®è·µï¼Œå¯ä»¥æœ‰æ•ˆé¿å…æ”¯ä»˜ç­‰å…³é”®ä¸šåŠ¡æ“ä½œçš„é‡å¤æ‰§è¡Œé—®é¢˜ï¼Œç¡®ä¿ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œç”¨æˆ·èµ„é‡‘çš„å®‰å…¨ã€‚